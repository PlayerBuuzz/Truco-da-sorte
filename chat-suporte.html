<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>TÃ´comfome ðŸ’¬ | Suporte</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --laranja:#ff8c1a;
  --cinza:#f5f5f5;
  --sombra:rgba(0,0,0,.08);
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Segoe UI',Arial;
}

body{
  background:var(--cinza);
  display:flex;
  flex-direction:column;
  height:100vh;
}

/* HEADER */
.header{
  background:#fff;
  padding:14px;
  text-align:center;
  box-shadow:0 2px 6px var(--sombra);
  font-weight:700;
  color:var(--laranja);
}

/* CHAT */
.chat{
  flex:1;
  padding:14px;
  overflow-y:auto;
}

/* MENSAGEM */
.msg{
  max-width:75%;
  padding:10px 14px;
  border-radius:14px;
  margin-bottom:10px;
  font-size:.9em;
  line-height:1.4;
}

.cliente{
  background:var(--laranja);
  color:#fff;
  margin-left:auto;
  border-bottom-right-radius:4px;
}

.suporte{
  background:#fff;
  color:#333;
  border-bottom-left-radius:4px;
  box-shadow:0 2px 6px var(--sombra);
}

/* INPUT */
.input-area{
  background:#fff;
  padding:10px;
  display:flex;
  gap:10px;
  box-shadow:0 -2px 6px var(--sombra);
}

.input-area input{
  flex:1;
  padding:12px;
  border-radius:12px;
  border:1px solid #ddd;
}

.input-area button{
  padding:12px 18px;
  border:none;
  border-radius:12px;
  background:var(--laranja);
  color:#fff;
  font-weight:600;
}
</style>
</head>

<body>

<div class="header">ðŸ’¬ Suporte ao Cliente</div>

<div class="chat" id="chat"></div>

<div class="input-area">
  <input id="mensagem" placeholder="Digite sua mensagem...">
  <button onclick="enviar()">Enviar</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  doc,
  setDoc,
  onSnapshot,
  query,
  orderBy,
  serverTimestamp,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
  authDomain: "tocomfome-754e1.firebaseapp.com",
  projectId: "tocomfome-754e1",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const chatBox = document.getElementById("chat");
const input = document.getElementById("mensagem");

let chatId = null;
let clienteNome = "";

/* LOGIN */
onAuthStateChanged(auth, async user=>{
  if(!user){
    location.href = "login-cliente.html";
    return;
  }

  const snap = await getDoc(doc(db,"clientes",user.uid));
  clienteNome = snap.exists() ? snap.data().nome : "Cliente";

  iniciarChat(user.uid);
});

/* CRIAR / ABRIR CHAT */
async function iniciarChat(clienteId){
  chatId = clienteId; // 1 chat por cliente (simples e eficiente)

  await setDoc(doc(db,"chats",chatId),{
    clienteId,
    clienteNome,
    status:"aberto",
    criadoEm: serverTimestamp()
  },{merge:true});

  ouvirMensagens();
}

/* OUVIR MENSAGENS (REAL TIME) */
function ouvirMensagens(){
  const q = query(
    collection(db,"chats",chatId,"mensagens"),
    orderBy("criadoEm")
  );

  onSnapshot(q,snap=>{
    chatBox.innerHTML = "";
    snap.forEach(docu=>{
      const m = docu.data();
      chatBox.innerHTML += `
        <div class="msg ${m.autor}">
          ${m.texto}
        </div>
      `;
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

/* ENVIAR */
window.enviar = async ()=>{
  const texto = input.value.trim();
  if(!texto) return;

  await addDoc(
    collection(db,"chats",chatId,"mensagens"),
    {
      texto,
      autor:"cliente",
      criadoEm: serverTimestamp()
    }
  );

  input.value = "";
};
</script>
</body>
</html>
