<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>TÃ´comfome | Meu Perfil</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --laranja:#ff8c1a;
  --laranja-escuro:#e67300;
  --cinza:#f4f4f4;
  --cinza-claro:#fafafa;
  --texto:#333;
}

/* Tema escuro */
body.dark-theme{
  --cinza:#1e1e1e;
  --cinza-claro:#2a2a2a;
  --texto:#f5f5f5;
  background:var(--cinza);
  color:var(--texto);
}

*{
  box-sizing:border-box;
}

body{
  margin:0;
  background:var(--cinza);
  font-family:'Segoe UI', Arial, sans-serif;
  color:var(--texto);
}

/* HEADER */
.header{
  background:var(--laranja);
  color:#fff;
  padding:14px;
  text-align:center;
  font-size:1.1em;
  font-weight:600;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
}

.header img{
  width:22px;
  vertical-align:middle;
  margin-right:6px;
}

/* CONTAINER */
.wrapper{
  max-width:440px;
  margin:0 auto;
  padding:18px;
}

/* CARD */
.card{
  background:#fff;
  border-radius:22px;
  padding:22px;
  box-shadow:0 6px 18px rgba(0,0,0,.1);
}
body.dark-theme .card{
  background:#2a2a2a;
}

/* PERFIL TOPO */
.perfil-topo{
  text-align:center;
  margin-bottom:20px;
}
.avatar{
  width:80px;
  height:80px;
  border-radius:50%;
  background:var(--laranja);
  display:flex;
  align-items:center;
  justify-content:center;
  margin:0 auto 10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.15);
}
.avatar img{
  width:60px;
  height:60px;
  border-radius:50%;
}
.perfil-topo span{
  font-size:.9em;
  color:#777;
}
body.dark-theme .perfil-topo span{
  color:#ccc;
}

/* FORM */
label{
  display:block;
  font-size:.8em;
  color:#666;
  margin-bottom:5px;
  font-weight:500;
}
body.dark-theme label{
  color:#ddd;
}

input{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1.5px solid #ddd;
  background:var(--cinza-claro);
  font-size:.95em;
  margin-bottom:16px;
  transition:border-color 0.25s ease, box-shadow 0.25s ease;
}
body.dark-theme input{
  background:#333;
  border:1.5px solid #555;
  color:#fff;
}

input:focus{
  outline:none;
  border-color:var(--laranja);
  background:#fff;
  box-shadow:0 0 6px rgba(255,140,26,0.4);
}
body.dark-theme input:focus{
  background:#444;
}

/* BOTÃ•ES */
button{
  width:100%;
  padding:15px;
  border:none;
  border-radius:14px;
  font-size:1em;
  font-weight:600;
  cursor:pointer;
  transition:all 0.3s ease;
}

button img{
  width:18px;
  vertical-align:middle;
  margin-right:6px;
}

.btn-salvar{
  background:var(--laranja);
  color:#fff;
  box-shadow:0 3px 8px rgba(0,0,0,0.12);
}
.btn-salvar:hover{
  background:var(--laranja-escuro);
}

.btn-sair{
  background:#444;
  color:#fff;
  margin-top:12px;
}
.btn-sair:hover{
  background:#222;
}

/* BotÃ£o de tema */
.btn-tema{
  background:#fff;
  color:var(--laranja);
  border:1.5px solid var(--laranja);
  margin-top:12px;
}
body.dark-theme .btn-tema{
  background:#333;
  color:#fff;
  border:1.5px solid #fff;
}
</style>
</head>

<body>

<div class="header">
  <img src="img/perfil1.png" alt="Perfil"> Meu Perfil
</div>

<div class="wrapper">
  <div class="card" id="conteudo" style="display:none">

    <div class="perfil-topo">
      <div class="avatar">
        <img src="img/logo.png" alt="Logo TÃ´comfome">
      </div>
      <strong id="nomeTopo"></strong><br>
      <span>Cliente TÃ´comfome</span>
    </div>

    <label>Nome</label>
    <input id="nome" disabled>

    <label>CPF</label>
    <input id="cpf" disabled>

    <label>Email</label>
    <input id="email">

    <label>Celular</label>
    <input id="celular">

    <label>Bairro</label>
    <input id="bairro">

    <label>Cidade</label>
    <input id="cidade">

    <button class="btn-salvar" onclick="salvar()">
      <img src="img/salvar.png"> Salvar alteraÃ§Ãµes
    </button>

    <button class="btn-sair" onclick="sair()">
      <img src="img/sair.png"> Sair da conta
    </button>

    <button class="btn-tema" onclick="toggleTema()">
      ðŸŒ™ Alternar Tema
    </button>

  </div>
</div>

<script type="module">
/* ===========================
   ðŸŒ— TEMA GLOBAL (CORRIGIDO)
=========================== */
if(localStorage.getItem("tema") === "dark"){
  document.documentElement.classList.add("dark-theme");
}

/* ===========================
   ðŸ”¥ FIREBASE
=========================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
  authDomain: "tocomfome-754e1.firebaseapp.com",
  projectId: "tocomfome-754e1",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ===========================
   ðŸ”§ ELEMENTOS DOM
=========================== */
const lista = document.getElementById("listaProdutos");
const usuarioEl = document.getElementById("usuario");
const enderecoEl = document.querySelector(".endereco span");
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("overlay");
const buscaInput = document.getElementById("buscaInput");
const chatBalao = document.getElementById("chat-balao");

let produtos = [];

/* ===========================
   ðŸ“‚ MENU
=========================== */
window.toggleMenu = ()=>{
  sidebar.classList.toggle("active");
  overlay.classList.toggle("active");
}
window.fecharMenu = ()=>{
  sidebar.classList.remove("active");
  overlay.classList.remove("active");
}

/* ===========================
   ðŸ‘¤ USUÃRIO + ENDEREÃ‡O
=========================== */
onAuthStateChanged(auth, async (user)=>{
  if(user){
    const snap = await getDoc(doc(db,"clientes",user.uid));
    if(snap.exists()){
      const dados = snap.data();
      usuarioEl.innerText = dados.nome.split(" ")[0];

      if(dados.rua && dados.numero && dados.bairro && dados.cidade){
        enderecoEl.innerText = `${dados.rua}, ${dados.numero} - ${dados.bairro}, ${dados.cidade}`;
      }else if(dados.bairro && dados.cidade){
        enderecoEl.innerText = `${dados.bairro}, ${dados.cidade}`;
      }else{
        enderecoEl.innerText = "EndereÃ§o nÃ£o cadastrado";
      }
    }else{
      usuarioEl.innerText = "UsuÃ¡rio";
      enderecoEl.innerText = "EndereÃ§o nÃ£o encontrado";
    }
  }else{
    usuarioEl.innerText = "Visitante";
    enderecoEl.innerText = "EndereÃ§o nÃ£o disponÃ­vel";
  }
});

/* ===========================
   ðŸšª LOGOFF
=========================== */
window.logoff = async ()=>{
  await signOut(auth);
  window.location.href = "index.html";
}

/* ===========================
   ðŸ§­ NAVEGAÃ‡ÃƒO
=========================== */
window.irPerfil = ()=> location.href = auth.currentUser ? "perfil.html" : "login-cliente.html";
window.irInicio = ()=> location.href = "index.html";
window.irBusca = ()=> buscaInput.focus();
window.irPedidos = ()=> location.href = "pedidos.html";

/* ===========================
   ðŸ” PRODUTOS
=========================== */
async function carregarProdutos(){
  produtos = [];
  lista.innerHTML = "";

  const comerciosSnap = await getDocs(collection(db,"comercios"));

  for(const comercioDoc of comerciosSnap.docs){
    const comercio = comercioDoc.data();
    if(!comercio.ativo) continue;

    const produtosSnap = await getDocs(
      collection(db,"comercios",comercioDoc.id,"produtos")
    );

    produtosSnap.forEach(prodDoc=>{
      const p = prodDoc.data();

      const produto = {
        id: prodDoc.id,
        comercioId: comercioDoc.id,
        nome: p.nome,
        valor: p.valor,
        descricao: p.descricao || "",
        categoria: p.categoria || "",
        img: p.img || "https://images.unsplash.com/photo-1550547660-d9450f859349",
        comercio: comercio.nome,
        bairro: comercio.endereco?.bairro || "",
        cidade: comercio.endereco?.cidade || ""
      };

      produtos.push(produto);
      render(produto);
    });
  }
}

/* ===========================
   ðŸŽ¨ RENDER
=========================== */
function render(p){
  lista.innerHTML += `
    <div class="card">
      <img src="${p.img}">
      <div class="card-info">
        <h4>${p.nome}</h4>
        <div class="preco">
          ${Number(p.valor).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
        </div>
        <div class="comercio-link" onclick="abrirComercio('${p.comercioId}')">
          ${p.comercio}
        </div>
        <div style="font-size:.8em;color:#666">
          ${p.bairro} â€¢ ${p.cidade}
        </div>
        <button class="btn" onclick="pedir('${p.id}')">Pedir</button>
      </div>
    </div>
  `;
}

/* ===========================
   ðŸ”Ž BUSCA
=========================== */
buscaInput.addEventListener("input", ()=>{
  const termo = buscaInput.value.toLowerCase();
  lista.innerHTML = "";

  produtos
    .filter(p =>
      p.nome.toLowerCase().includes(termo) ||
      p.descricao.toLowerCase().includes(termo) ||
      p.categoria.toLowerCase().includes(termo) ||
      p.comercio.toLowerCase().includes(termo)
    )
    .forEach(render);
});

/* ===========================
   ðŸ›’ PEDIR
=========================== */
window.pedir = (id)=>{
  const prod = produtos.find(p=>p.id===id);
  localStorage.setItem("produtoSelecionado", JSON.stringify(prod));
  location.href = "produto.html";
}

/* ===========================
   ðŸª PERFIL COMÃ‰RCIO
=========================== */
window.abrirComercio = (comercioId)=>{
  localStorage.setItem("comercioSelecionado", JSON.stringify({ comercioId }));
  location.href = "perfil-comercio.html";
}

/* ===========================
   ðŸ’¬ CHAT
=========================== */
chatBalao.addEventListener("click", ()=>{
  onAuthStateChanged(auth, (user)=>{
    location.href = user ? "chat-cliente.html" : "login-cliente.html";
  });
});

/* ===========================
   ðŸš€ INIT
=========================== */
carregarProdutos();
</script>
</body>
</html>
