<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>T√¥comfome üçî | Comandas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" type="image/ico" href="/img/Logo.png">

<style>
:root{
  --laranja:#ff8c1a;
  --laranja-esc:#ff6f00;
  --cinza:#f2f2f2;
  --card:#ffffff;
  --texto:#222;
  --texto-sec:#666;
  --borda:#eaeaea;
}

*{box-sizing:border-box}

body{
  margin:0;
  background:var(--cinza);
  font-family:'Segoe UI', Arial, sans-serif;
  color:var(--texto);
}

/* HEADER */
.header{
  background:linear-gradient(135deg,var(--laranja),var(--laranja-esc));
  color:#fff;
  padding:18px;
  text-align:center;
  font-size:1.2em;
  font-weight:700;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
  position:sticky;
  top:0;
  z-index:10;
}

/* LISTA */
.lista{
  padding:14px;
  max-width:520px;
  margin:auto;
}

/* CARD */
.card{
  background:var(--card);
  border-radius:18px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
  border-left:6px solid var(--laranja);
  animation:fade .3s ease;
}

@keyframes fade{
  from{opacity:0;transform:translateY(6px)}
  to{opacity:1;transform:none}
}

.card h4{
  margin:0 0 6px;
  font-size:1em;
}

/* PRE√áO */
.preco{
  color:var(--laranja);
  font-weight:800;
  font-size:1.1em;
  margin-bottom:6px;
}

/* INFOS */
.info{
  font-size:.85em;
  color:var(--texto-sec);
  margin:3px 0;
}

/* STATUS */
.status{
  display:inline-block;
  padding:6px 14px;
  border-radius:999px;
  font-size:.7em;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.5px;
  margin:10px 0 6px;
}

.status.novo{
  background:#fff3cd;
  color:#856404;
  border-left:4px solid #ffc107;
}

.status.preparando{
  background:#d1ecf1;
  color:#0c5460;
  border-left:4px solid #17a2b8;
}

.status.saiu{
  background:#cce5ff;
  color:#004085;
  border-left:4px solid #007bff;
}

.status.entregue{
  background:#d4edda;
  color:#155724;
  border-left:4px solid #28a745;
}

/* A√á√ïES */
.acoes{
  display:flex;
  gap:8px;
  margin-top:10px;
}

.acoes button{
  flex:1;
  padding:11px;
  border:none;
  border-radius:14px;
  font-size:.8em;
  font-weight:700;
  cursor:pointer;
  transition:.2s;
}

.acoes button:hover{
  transform:translateY(-1px);
  filter:brightness(1.05);
}

.btn-preparar{
  background:#17a2b8;
  color:#fff;
}

.btn-saiu{
  background:#007bff;
  color:#fff;
}

.btn-entregue{
  background:#28a745;
  color:#fff;
}

/* VAZIO */
.vazio{
  text-align:center;
  color:var(--texto-sec);
  margin-top:60px;
  font-size:.95em;
}
</style>

</head>

<body>
<div class="header">Comandas ativas</div>
<div class="lista" id="listaPedidos"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  onSnapshot,
  doc,
  getDoc,
  updateDoc,
  setDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

/* üî• Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
  authDomain: "tocomfome-754e1.firebaseapp.com",
  projectId: "tocomfome-754e1",
  storageBucket: "tocomfome-754e1.appspot.com",
  messagingSenderId: "997975886937",
  appId: "1:997975886937:web:9bf408c35f1ed8aea13548"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const messaging = getMessaging(app);

const lista = document.getElementById("listaPedidos");

/* Service Worker */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/firebase-messaging-sw.js");
}

/* Token FCM */
async function registrarToken(uid){
  const permission = await Notification.requestPermission();
  if(permission !== "granted") return;

  const registration = await navigator.serviceWorker.ready;
  const token = await getToken(messaging,{
    vapidKey:"BB3N1EQpjWRYNQQpB_Dwo1lCScMl03xYIq_WrJo_nxs5HcKbRrUze3ATLLlW9B0xV3Trm6Fm_NwAMvQeLcJBTgU",
    serviceWorkerRegistration: registration
  });

  if(token){
    await setDoc(doc(db,"tokens",uid),{
      token,
      atualizadoEm: serverTimestamp()
    });
  }
}

/* Buscar cliente */
async function buscarCliente(clienteId){
  try{
    const ref = doc(db,"clientes",clienteId);
    const snap = await getDoc(ref);
    if(snap.exists()) return snap.data();
    return null;
  }catch(e){
    console.error(e);
    return null;
  }
}

/* Status */
window.mudarStatus = async (id,status)=>{
  if(!confirm("Confirmar altera√ß√£o de status?")) return;
  await updateDoc(doc(db,"pedidos",id),{ status });
};

/* Pedidos */
function carregarPedidos(uid){
  const q = query(
    collection(db,"pedidos"),
    where("comercioId","==",uid)
  );

  onSnapshot(q, async snap=>{
    lista.innerHTML = "";

    if(snap.empty){
      lista.innerHTML = `<div class="vazio">Nenhum pedido</div>`;
      return;
    }

    for(const d of snap.docs){
      const p = d.data();
      if(p.status === "entregue") continue;

      const cliente = await buscarCliente(p.clienteId);

      const endereco = cliente?.endereco
        ? `${cliente.endereco.rua}, ${cliente.endereco.numero} - ${cliente.endereco.bairro} (${cliente.endereco.cidade})`
        : "Endere√ßo n√£o informado";

      lista.innerHTML += `
        <div class="card">
          <h4>${p.produtoNome}</h4>
          <div class="preco">R$ ${Number(p.valor).toFixed(2)}</div>

          <div class="info">üë§ ${cliente?.nome || "-"}</div>
          <div class="info">üìû ${cliente?.celular || "-"}</div>
          <div class="info">üìç ${endereco}</div>

          <div class="status ${p.status || "novo"}">${p.status || "novo"}</div>

          <div class="acoes">
            ${p.status==="novo"
              ? `<button class="btn-preparar" onclick="mudarStatus('${d.id}','preparando')">üë®‚Äçüç≥ Preparar</button>`
              : ""
            }
            ${p.status==="preparando"
              ? `<button class="btn-saiu" onclick="mudarStatus('${d.id}','saiu')">üõµ Saiu</button>`
              : ""
            }
            ${p.status==="saiu"
              ? `<button class="btn-entregue" onclick="mudarStatus('${d.id}','entregue')">‚úÖ Entregue</button>`
              : ""
            }
          </div>
        </div>
      `;
    }
  });
}

/* Auth */
onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="Comercio/login-comercio.html";
    return;
  }
  registrarToken(user.uid);
  carregarPedidos(user.uid);
});

/* Notifica√ß√£o em primeiro plano */
onMessage(messaging,(payload)=>{
  new Notification(payload.notification.title,{
    body: payload.notification.body,
    icon: "/img/logo.png"
  });
});
</script>
</body>
</html>
