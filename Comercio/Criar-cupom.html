<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>T√¥comfome üçî | Meus Cupons</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/ico" href="/img/Logo.png">

<style>
:root{
  --laranja:#ff8c1a;
  --laranja-esc:#ff6f00;
  --cinza:#f2f2f2;
  --branco:#fff;
  --texto:#222;
  --texto-sec:#666;
}

*{box-sizing:border-box;font-family:'Segoe UI',Arial}

body{
  background:var(--cinza);
  margin:0;
  padding:20px;
  display:flex;
  justify-content:center;
}

/* CONTAINER */
.box{
  width:100%;
  max-width:460px;
  background:var(--branco);
  border-radius:22px;
  box-shadow:0 12px 30px rgba(0,0,0,.12);
  overflow:hidden;
}

/* HEADER */
.header{
  background:linear-gradient(135deg,var(--laranja),var(--laranja-esc));
  color:#fff;
  padding:18px;
  text-align:center;
  font-size:1.2em;
  font-weight:700;
}

/* A√á√ïES */
.topo{
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.criar{
  border:none;
  background:var(--laranja);
  color:#fff;
  padding:13px;
  border-radius:14px;
  font-weight:700;
  cursor:pointer;
  transition:.2s;
}
.criar:hover{filter:brightness(1.05)}

/* FILTRO */
.filtro{
  padding:10px;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:.9em;
}

/* RESUMO */
.resumo{
  display:flex;
  gap:10px;
  padding:0 16px 16px;
}

.box-resumo{
  flex:1;
  background:#fafafa;
  border-radius:14px;
  padding:10px;
  text-align:center;
  border:1px solid #eee;
}

.box-resumo strong{
  display:block;
  color:var(--laranja);
  font-size:1.1em;
}

/* LISTA */
.lista{
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* CUPOM */
.cupom{
  background:#fff;
  border-radius:16px;
  padding:14px;
  box-shadow:0 6px 14px rgba(0,0,0,.08);
  border-left:6px solid #ccc;
}

.cupom.ativo{border-color:#22c55e}
.cupom.inativo{border-color:#ef4444}

.cupom h3{
  margin:0;
  font-size:1.1em;
}

.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  font-size:.7em;
  font-weight:700;
  margin-top:6px;
}

.badge.ativo{background:#dcfce7;color:#166534}
.badge.inativo{background:#fee2e2;color:#7f1d1d}

.info{
  font-size:.85em;
  color:var(--texto-sec);
  margin-top:4px;
}

/* A√á√ïES */
.acoes{
  display:flex;
  gap:8px;
  margin-top:10px;
}

.acoes button{
  flex:1;
  border:none;
  padding:9px;
  border-radius:10px;
  font-size:.8em;
  font-weight:700;
  cursor:pointer;
  transition:.2s;
}

.acoes button:hover{transform:translateY(-1px)}

.btn-editar{background:#2563eb;color:#fff}
.btn-excluir{background:#dc2626;color:#fff}

/* VAZIO */
.vazio{
  text-align:center;
  color:#777;
  font-size:.9em;
  padding:30px 10px;
}

/* VOLTAR */
.voltar{
  padding:14px;
  text-align:center;
  font-size:.9em;
  color:#666;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="box">

  <div class="header">üéüÔ∏è Meus Cupons</div>

  <div class="topo">
    <button class="criar" onclick="criarCupom()">‚ûï Criar Novo Cupom</button>
    <input id="filtro" class="filtro" placeholder="üîç Buscar cupom">
  </div>

  <div class="resumo">
    <div class="box-resumo">
      <span>Total</span>
      <strong id="total">0</strong>
    </div>
    <div class="box-resumo">
      <span>Ativos</span>
      <strong id="ativos">0</strong>
    </div>
  </div>

  <div id="lista" class="lista"></div>

  <div class="voltar" onclick="history.back()">‚Üê Voltar</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, query, orderBy,
  doc, deleteDoc, updateDoc, addDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
  authDomain: "tocomfome-754e1.firebaseapp.com",
  projectId: "tocomfome-754e1",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const comercio = JSON.parse(localStorage.getItem("comercioSelecionado"));
if(!comercio?.comercioId){
  alert("Com√©rcio n√£o identificado");
  location.href="/comercio/painel.html";
}

const lista = document.getElementById("lista");
const filtro = document.getElementById("filtro");
const total = document.getElementById("total");
const ativos = document.getElementById("ativos");

let cupons = [];

/* CRIAR */
window.criarCupom = async ()=>{
  const nome = prompt("Nome do cupom:");
  if(!nome) return;
  const desconto = prompt("Desconto (%):");
  if(!desconto) return;
  const validade = prompt("Validade (AAAA-MM-DD):");
  if(!validade) return;
  const ativo = confirm("Ativar agora?");

  await addDoc(collection(db,"comercios",comercio.comercioId,"cupons"),{
    nome:nome.toUpperCase(),
    desconto:Number(desconto),
    validade,
    ativo,
    criadoEm:serverTimestamp()
  });

  carregar();
};

/* RENDER */
function render(){
  lista.innerHTML="";
  let qtdAtivos = 0;

  cupons
    .filter(c=>c.nome.includes(filtro.value.toUpperCase()))
    .forEach(c=>{
      if(c.ativo) qtdAtivos++;

      lista.innerHTML += `
        <div class="cupom ${c.ativo?'ativo':'inativo'}">
          <h3>${c.nome}</h3>
          <span class="badge ${c.ativo?'ativo':'inativo'}">
            ${c.ativo?'Ativo':'Inativo'}
          </span>
          <div class="info">üí∞ ${c.desconto}% de desconto</div>
          <div class="info">üìÖ ${formatarData(c.validade)}</div>
        </div>
      `;
    });

  total.textContent = cupons.length;
  ativos.textContent = qtdAtivos;

  if(!cupons.length){
    lista.innerHTML = `<div class="vazio">Nenhum cupom criado</div>`;
  }
}

filtro.addEventListener("input",render);

/* CARREGAR */
async function carregar(){
  cupons=[];
  const ref = collection(db,"comercios",comercio.comercioId,"cupons");
  const q = query(ref,orderBy("criadoEm","desc"));
  const snap = await getDocs(q);
  snap.forEach(d=> cupons.push({...d.data(),id:d.id}));
  render();
}

function formatarData(d){
  return new Date(d).toLocaleDateString("pt-BR");
}

carregar();
</script>

</body>
</html>